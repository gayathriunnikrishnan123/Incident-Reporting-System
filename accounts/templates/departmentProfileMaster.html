{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Profile mapping{% endblock %}
{% block page_title %}Department-Profile Mapping{% endblock %}

{% block headersPart %}
    <link rel="stylesheet" href="{% static 'css/user_form.css' %}">

    <link rel="stylesheet" href="{% static "css/userMaster.css" %}">

        <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">

    <!-- jQuery (Required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
{% endblock headersPart %}



{% block content %}


<div class="mainCont">
    <div class="form-container">

        <form method="post">
            {% csrf_token %}
            
            <!-- Display form errors -->
            {% if form.non_field_errors %}
                <div class="form-errors">
                    {% for error in form.non_field_errors %}
                        <div class="error-message">{{ error }}</div>
                    {% endfor %}
                </div>
            {% endif %}
            

            <div class="form-group">
                <label for="{{ form.user.id_for_label }}" class="form-label">User</label>
                {{ form.user }}
                {% if form.user.errors %}
                    {% for error in form.user.errors %}
                        <div class="error-message">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.role.id_for_label }}" class="form-label">Role</label>
                {{ form.role }}
                {% if form.role.errors %}
                    {% for error in form.role.errors %}
                        <div class="error-message">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="form-group" id="division-group">
                <label for="{{ form.division.id_for_label }}" class="form-label">Division</label>
                {{ form.division }}
                {% if form.division.errors %}
                    {% for error in form.division.errors %}
                        <div class="error-message">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="form-group" id="department-group">
                <label for="{{ form.department.id_for_label }}" class="form-label">Department</label>
                {{ form.department }}
                {% if form.department.errors %}
                    {% for error in form.department.errors %}
                        <div class="error-message">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.is_active.id_for_label }}" class="form-label">Active</label>
                {{ form.is_active }}
                {% if form.is_active.errors %}
                    {% for error in form.is_active.errors %}
                        <div class="error-message">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>
            {% comment %} <button type="submit" class="submit-btn">
                Create role
            </button> {% endcomment %}
            {% if edit_mode %}
                <button type="submit" class="submit-btn">Update Map</button>
            {% else %}
                <button type="submit" class="submit-btn">Create Map</button>
            {% endif %}
            <button type="reset" class="reset-btn">
                reset
            </button>
        </form>
    </div>


    <div class="table-wrapper">
        <table id="userTable" class="display responsive nowrap" style="width:100%">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Fullname</th>
                    <th>Division</th>
                    <th>Department</th>
                    <td>Role assigned</td>
                    <td>Active</td>
                    <td>Actions</td>
                </tr>
            </thead>
            <tbody>
                {% for map in allMappings %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ map.user.fullname }}</td>
                    <td>{{ map.division }}</td>
                    <td>{{ map.department }}</td>
                    <td>{{ map.role }}</td>
                    <td>{{ map.is_active }}</td>
                    <td>

                        <a href="{% url "edit-map" map.id %}"class="action-btn edit-btn">Edit</a>
                        <form method="post" action="{% url 'delete-map' map.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="action-btn delete-btn"
                                onclick="return confirm('Are you sure you want to delete this mapping?');">
                                Delete
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>


    {% comment %} <script src="{% static 'js/user_form.js' %}"></script> {% endcomment %}


{% endblock %}

{% block extra_js %}

    {% comment %} <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script> {% endcomment %}

    <script>
        $(document).ready(function () {
            $('#userTable').DataTable({
                responsive: true,
                pageLength: 10,
                lengthMenu: [3, 10, 25, 50],
                lengthChange: true,
                searching: true,
                ordering: true
            });
        });
    </script>

    <script>
        $(document).ready(function () {
            $('#division-group, #department-group').hide();

            $('#id_role').change(function () {
                var roleVal = $('#id_role option:selected').text().toLowerCase();

                if (roleVal === 'responder') {
                    $('#division-group, #department-group').show();
                    $('#id_department').prop("disabled", true);

                    
                    $('#id_division').off('change').on('change', function () {
                        var divisionId = $(this).val();
                        console.log("Selected division:", divisionId);

                        if (divisionId) {
                            $.ajax({
                                url: "{% url 'ajax_load_departments' %}",
                                data: { division_id: divisionId },
                                success: function (data) {
                                    var departmentSelect = $("#id_department");
                                    departmentSelect.empty();
                                    departmentSelect.append('<option value="">Select Department</option>');
                                    $.each(data, function (index, dept) {
                                        departmentSelect.append('<option value="' + dept.id + '">' + dept.name + '</option>');
                                    });
                                    departmentSelect.prop("disabled", false);
                                },
                                error: function () {
                                    console.error("Failed to fetch departments");
                                }
                            });
                        } else {
                            $("#id_department").empty().append('<option value="">Select Department</option>').prop("disabled", true);
                        }
                    });

                } else if (roleVal === 'reviewer') {
                    $('#division-group').show();
                    $('#department-group').hide();
                    $('#id_department').empty().append('<option value="">Select Department</option>').prop("disabled", true);

                } else {
                    $('#division-group, #department-group').hide();
                    $('#id_department').empty().append('<option value="">Select Department</option>').prop("disabled", true);
                }
            });
        });

    </script>


{% endblock extra_js %}